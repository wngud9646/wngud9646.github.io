---
title:  "Final Project 요구사항 구현"
excerpt: "Final"

categories:
  - Blog
tags:
  - [Blog, DevOps]

toc: true
toc_sticky: true
 
date: 2023-06-14
last_modified_at: 2023-06-15
---
## 담당업무
CI/CD 구현 및 WAS 작업 <br>
초기에는 WAS 작업을 진행하다, CI 작업을 진행.

## 트러블슈팅(15~16일)

### express에서 사용한 database.js와 secret.js를 next.js에서 쓰려니까 에러가 발생
기존 프로젝트에서 express에서 데이터베이스를 연결하기 위한 플러그인으로 database.js와 데이터베이스 접속 정보를 환경변수로써 AWS Secret Manager에서 정보를 가져오는 코드를 가지고 있었다.

해당 코드들을 가져다가 사용하고자, next.js 환경에서 그대로 가져왔더니 에러가 발생했다.

마이그레이션 할 때, 가장 큰 차이점으로 보였던 것은,  express에서는 next 함수를 사용하는데 next.js에서는 사용하지 못한다.

express의 next 함수는 미들웨어 스택에서 현재 미들웨어의 처리가 완료되면 다음 미들웨어로 제어를 넘기는 역할을 하고, next.js는 페이지의 라우팅이 파일 시스템 기반으로 작동하기 때문에 해당 함수를 사용할 수 없다.

또한 데이터베이스와 연결하는 함수인 connectDb는 import로 가져왔으며, 가져온 후에도 해당 함수로 초기화를 진행해줘야 정상적으로 사용할 수 있었다.

### github action 관련
#### Dockerfile을 찾지 못함
일단 이 시점에서 만든 github action은 내가 만든 WAS를 docker image로 만들어 ECR로 배포하는 action을 구성하였다. <br>

최초에는 action template으로 action을 생성했는데,<br>
에러: Dockerfile not found 발생<br>
원인: WAS를 image로 만드는 Dockerfile을 만들지 않은 상태에서, action을 먼저 생성시켜 이미지 빌드시에 에러가 발생했다.

이후 WAS 디렉토리에 Dockerfile을 만들고, Action을 실행하였더니, 

에러: Dockerfile not found 발생<br>
원인: Dockerfile이 github action이 작업하는 디렉토리와 다른 디렉토리에 있는 것이 원인이였다.<br>
해결: github action은 checkout으로 레포지토리의 내용을 가져가고, 레포지토리의 루트에서 작업을 하는데, WAS는 /server 디렉토리 안에 있느 상황이였기에, action 중간에 cd server 명령어를 추가해 주었다.

에러: docker image build failed, Dockerfile 내부의 npm run build 작업에서 오류 발생<br>
원인: build하기 위한 파일이 부족. npm run build를 하기 전에 Copy . . 으로 작업 디렉토리로 파일들을 복사해가야하는데 해당 작업 전에 npm run build가 실행됨. 빌드할 리소스들이 없으니 에러가 발생.<br>
해결: Dockerfile의 명령 순서를 변경하였다.



### Jenkins CI 관련
#### jenkins webhook 관련
문제: Webhook을 사용해야하는데, github에서 localhost를 인식 못함.<br>
원인: 현재 local에서 container로 jenkins를 돌리고 있음.<br>
해결: 이 문제에서 일단 container가 공용 ip 주소를 가져야한다는 것은 인식하였다. <br>
하지만 내 로컬 환경의 container가 ip를 가져야한다는 것에 대한 레퍼런스를 충분히 찾지를 못했다.(실제로 추후에 찾았다...)<br>
일단 단순하게 접근해서 public ip가 필요함 => EC2에서 public ip 받고 인스턴스에서 구성하자라는 방식으로 접근


문제: jenkins webhook error, HTTP ERROR 403 No valid crumb was included in the request<br>
원인: HTTP 오류 403은 "Forbidden" 오류, "No valid crumb was included in the request"는 요청에 유효한 crumb(쿠키 또는 토큰과 같은 인증 정보)이 포함되어 있지 않았다는 이야기인데<br>
해결: [reference](https://honeyinfo7.tistory.com/293) <br>
해당 레퍼런스를 참조하였지만 실제로는 http://[젠킨스 주소]/github-webhook/로 webhook url을 작성해야하는데, github-webhook 안붙여서 생긴 오류.. <br>
맨 뒤에 /를 안붙이면 302에러가 발생한다.


에러: jenkins pipeline error, checkout scm 에러<br>
원인: checkout scm은 pipeline script for scm이나, multi-configuration-project에서만 사용 가능<br>
해결: pipeline을 pipeline script for scm으로 변경, 해당 pipeline은 jenkins에서 script를 관리하지 않고, github 레포지토리에서 Jenkinsfile로 pipeline이 작동하므로, 마이그레이션


문제: jenkins에서 빌드시에 속도가 엄청나게 느려짐
원인: EC2 instance가 t2.micro라 인스턴스의 RAM이 감당을 못함
해결: [reference](https://tape22.tistory.com/22), EC2의 볼륨을 RAM처럼 사용할 수 있게 해주는 작업을 통해 속도 향상.

에러: jenkins에서 docker image를 빌드해야하는데, docker 명령어를 사용못함.
원인: 해당 컨테이너 안에는 docker가 없으니깐, jenkins pipeline에서 docker 명령어가 안됨.
해결: 여러 레퍼런스들을 찾아보았고, 매우 명확하게 해결된 레퍼런스.<br>
[reference](https://narup.tistory.com/228) Dockerfile과 docker-compose.yml로 jenkins 이미지를 가져다가 컨테이너에 docker와 docker-compose를 설치하는 작업을 Dockerfile을 통해 실행한다.<br>
Docker in Docker라는 명칭이 있다.

에러: jenkins에서 Dockerfile 명령어 실행중에 npm에서 에러 발생.
원인: jenkins가 nodejs를 사용 못해서 발생하는 에러.
해결: jenkins plugin에서 nodejs 설치한 후에, jenkins 설정 Tool에 가서 nodejs 관련 설정을 한 후에, Jenkinsfile에 tool 영역을 작성하면 된다.

해당 부분까지 작업한 후에 실수로 인스턴스 종료 눌러서, 로컬에서 작업할 방향을 찾아보기로 함. <br>
핵심적인것은 제일 첫번째 문제였던 localhost의 컨테이너에 public ip를 주는 방법이 없을까라는 질문이였다.

문제: Webhook을 사용해야하는데, github에서 localhost를 인식 못함.<br>
원인: 현재 local에서 container로 jenkins를 돌리고 있음.<br>
해결: ngrok 사용하여 localhost container에 public dns를 부여할 수 있다. 해당 방식으로 로컬 상에서 jenkins를 구성.

에러: ECR registry push 에러
원인: jenkins credential에서 AWS credential을 저장해 놓았는데, 이를 Jenkinsfile에서 잘못된 형태로 사용하여, 인식을 못하는 에러.

```
docker.withRegistry("https://${ECR_PATH}", "ecr:${REGION}:${AWS_CREDENTIAL_NAME}")
```

해당 코드에서 pipeline: aws steps plugin을 설치하고,

```
withAWS(region:'ap-northeast-2', credentials:'wngud9646') {
                        def login = ecrLogin()
```

로그인 코드를 위와 같이 수정하였다.


### Git의 중요성
여기까지 CI 관련 작업들을 맡아 작업을 하였는데, 여기서 Git의 중요성을 많이 느끼게 되었다.

![alt text](/images/commit_graph.png)

매우 복잡하다.<br>
실제로 작성자의 경우에도 merge 되지 않고 방치되고 있는 branch도 있는 것을 확인할 수 있다.

4명이 협업하는 프로젝트이다보니, 변경점들에 대해서 branch 충돌도 자주 있는 편이며, 한 팀원이 실수로 프로젝트 레포지토리를 fork하지 않고 바로 clone해서 사용하였고, push가 branch들로 바로 들어가버리는 경우가 발생했었다.<br>
Git convention으로 모든 프로젝트 레포지토리로 merge 하는 작업에 대해서는 PR로 진행하기로 하였는데, 해당 실수로 도중에 바로 push된 commit이 발생하였고, 해당 commit으로 충돌도 발생했다.<br>
이를 바로 잡았지만, 이런식으로 git 형상관리가 협업에서 매우 중요한 점이라는 걸 크게 느낄 수 있었다.

또한 개인적으로 생각하는 점은 CI 관련 작업에서 내 레포지토리에서 작업을 작은 수정마다 커밋을 하여, 커밋 히스토리가 매우 늘어났다.<br>
작성자는 이러한 커밋 히스토리가 나쁘다고 생각했는데(갯수가 많아지고, 복잡해지니) 실제로는 의견이 좀 갈리는 편이라고 한다.<br>
하지만 실수로 중복 커밋명을 사용하거나 하는 실수가 있었기에 이런 부분에 대해 조심해야겠다고 느낄 수 있었다.<br>
현재 작업까지는 주로 개인 레포지토리 main branch에서 작업했는데, 작업에 따라 branch로 분화하는 습관을 들여 깔끔한 git 관리를 하고자 한다.

또한 Git convention 매우 중요하다...<br>
Convention을 철저히 해야, 협업 시에 conflict도 피할 수 있고, 커밋 히스토리도 깔끔하게 보기 좋을 것이다.

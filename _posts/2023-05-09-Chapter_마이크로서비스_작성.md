---
title:  "마이크로서비스 작성"
excerpt: "DevOps 부트캠프 Section 3"

categories:
  - Blog
tags:
  - [Blog, DevOps]

toc: true
toc_sticky: true
 
date: 2023-05-09
last_modified_at: 2023-05-09
---
# AWS Lambda
AWS 람다(Lambda)는 서버리스 컴퓨팅 FaaS 상품이다.

서버리스란 개발자가 서버를 관리할 필요 없이 애플리케이션을 빌드하고 실행할 수 있도록 하는 클라우드 네이티브 개발 모델이다.

즉, 클라우드 제공업체가 서버 인프라에 대한 프로비저닝, 유지 관리 등을 대신 처리해주기 때문에, 개발자는 조금 더 비즈니스 로직 작성에만 집중할 수 있게 된다.

AWS 람다는 서버를 프로비저닝하거나 관리할 필요 없이 코드를 실행하게 해주는 서버리스 컴퓨팅 서비스로서 모든 유형의 애플리케이션이나 백엔드 서비스에 대한 코드를 별도의 관리 없이 실행 가능하다.

사용자는 람다에다가 원하는 함수를 작성하고, 필요할 때 그 함수를 사용할 수 있다.

또한 다른 AWS 서비스들과 연동이 용이하다는 특징이 있다.

예를들어 이미지를 S3에서 읽어올 때, 람다 함수를 통해 필요한 크기로 Resize 하는 기능에도 사용 할 수 있다.

이처럼 다른 AWS 서비스에서 코드를 자동으로 트리거 하도록 설정하거나 웹 또는 모바일 앱에서 직접 코드를 호출할 수도 있다.

코드를 업로드만 하면 Lambda에서 높은 가용성으로 코드를 실행 및 확장하는 데 필요한 부분을 알아서 처리해주기도 한다.

<br><br>

## 스펙
### 지원 언어
Lambda는  파이썬, Node.js, 루비, 자바, C#, 파워셸, 구글 고 등으로 작성된 런타임(Runtime)을 지원한다.

자신이 익숙한 프로그래밍 언어로 자유롭게 코딩이 가능하다.

### 실행 환경
람다는 실행 환경 스펙 제한이 있다.

하드웨어 적으로도 비용 측면이나 공간 측면이나 업그레이드 할수 있는 메모리나 cpu 에 제한이 있듯이 람다에도 똑같이 적용된다라고 보면 된다.

- CPU : EC2 처럼 정해져있는게 아니고, 메모리에 따라 CPU 사양이 자동으로 설정되는 형태 
- 메모리 : 128MB ~ 10000MB (2020년 기준 10GB로 향상)
- 임시 저장용 디스크 공간 : 512MB
- 최대 실행 시간 : 900초 (람다 함수를 최대 15분 동안만 실행할 수 있다는 의미)
- 압축시 패키지 크기 : 50MB
- 압축을 풀었을 경우 패키지 크기 : 250MB

<br><br>

## 장점
1. 비용절감<br>
필요할때만 함수가 호출되어 처리한다는 점에서 항상 서버를 켜두고 있지 않아도 되므로 비용을 절약 할 수 있다.<br>
람다함수의 요청 수와 람다코드의 실행시간에 따라서 요금이 부과된다.

 

2. 인프라 운영관리 부담절감<br>
성능이나 보안 등 서버 자체의 관리는 AWS가 알아서 해주기 떄문에 서버를 관리할 필요가 없으니 운영관리에 대한 부담이 줄어든다. <br>
예를들어 트래픽이 증가하면 알아서 자동으로 오토스케일링이 된다.

> 참고로 람다는 컨테이너 개념으로 스케일링 된다.<br>
EC2의 오토 스케일링 같이 가상OS가 새로 생성되는게 아니라, OS 위에 독립적인 하나의 프로그램을 키는 방식이기 때문에 훨씬 가볍게 확장이 가능하다.<br>
이벤트가 발생할 때 생성되고 더 이상 사용하지 않을 때는 제거된다.

3. 빠른 개발 배포<br>
람다를 이용하게 되면 상당히 개발 및 배포에 대한 소요시간이 매우 짧아지게 된다.<br>
AWS 자체에서 많은 기능을 제공해주고 있어서 API연동이 쉬우며, Serverless의 강점인 배포방법도 정말 쉬운 편이다.<br>
그저 함수를 수정해주기만 하면 되기 때문이다.

4. 언제 Lambda를 쓰면 좋을까?<br>
코드를 계속 실행시키기 보다는 특정한 시기에만 실행시키는 경우에 Lambda를 사용하면 유용하다.<br>
- 서버 띄우지 않고 간단한 코드를 실행시키고 싶은 경우
- 특정 기간 또는 특정 주기로 코드를 실행시켜야 하는 경우
- 트리거가 실행될때만 코드를 실행시키고 싶은 경우


<br><br>


## 단점
1. 리소스 제한<br>
람다는 메모리(최대 10GB), 처리시간 (최대900초, 즉 15분)으로 제한되어 있다.<br>
즉, 하나의 함수가 한번 호출될때 AWS에서는 최대 10GB의 메모리까지 사용이 가능하며, 처리시간은 최대 15분 이라는 말이다.<br>
아무래도 직접 서버에서 돌리는 것보다 부족한 스펙이다.

2. Stateless (상태비저장)<br>
람다는 함수가 호출되면 새로운 컨테이너를 띄우는 방식이기 때문에 별도의 상태를 저장하지 않는다. <br>
이는 Lambda 함수가 이벤트에 의해 트리거 될 때마다 완전히 새로운 환경에서 호출된다는 것을 의미한다.<br>
그래서 이전 이벤트의 실행 컨텍스트에 대한 액세스 권한이 없다보니, db connection을 유지하는 것 같은 기능은 수행하지 못한다. 

3. ColdStart<br>
람다는 리소스를 효율적으로 사용하기 위해서 오랫동안 사용하지 않고 있을 경우 잠시 컴퓨팅파워를 꺼두고 있는다. <br>
그래서 다시 사용하려고 하면 람다 컨테이너를 띄우기 위해 서버가 켜지고 실행환경을 구성하기 위해 약간의 시간이 걸린다. <br>
즉, 요청이 와서 람다함수를 실행하게 되면 어느정도 딜레이가 발생하게 된다. <br>
하지만 EC2 같은 경우 항상 가동된 상태에서 요청을 받을 준비가 되었기 때문에 딜레이가 없다.<br>
이를 반댓말인 WarmStart라고도 불리운다.


```
[콜드스타트 해결방법]
1. 람다를 계속 호출해준다.
사실 항상 컨테이너가 준비되어 있게 하도록 람다를 지속적으로 호출해는게 가장 좋다.
하지만 호출이 될때마다 비용이 산정되는 방식이기 때문에 그만큼 비용이 더 들수도 있다.

2. 람다의 메모리를 늘려 스펙을 높인다. 
메모리를 더 할당할 수록 컴퓨팅 스펙이 높아지기 때문에 처리속도가 빨라져서 딜레이가 줄어들 수도 있다.

3. 프로비저닝된 동시성 활성화
2019년 콜드스타트 문제를 해결하기 위해 나온 옵션으로 함수의 호출에 바로 응답할 수 있게 미리 준비하는 옵션이다.
이를 활성화 하면 미리 함수의 환경을 세팅해두기 딜레이가 줄어들지만, 추가적인 비용이 든다.
```



4. 동시성 제한<br>
동시성이란 특정 시각에 함수가 제공하는 요청의 수이다.<br>
함수가 호출되면 Lambda는 함수의 인스턴스를 할당하여 이벤트를 처리하고, 실행이 마치면, 다른요청을 처리할 수 있다.<br>
람다는 각 리전별로 동시에 실행할 수 있는 람다함수의 개수를 최대 1000개로 제한하고 있다.<br>
그래서 request 수 이를 넘어가게 되면 람다가 수행되지 않는 문제점이 발생할 수도 있다.


[람다의 동시성]<br>
동시성이란 특정시간에 람다함수가 처리할 수 있는 request의 수이다.<br>
람다는 기본적으로 1개의 워커를 가지고 있는 컨테이너의 개념이다 그래서 reqeuest에 의해 람다함수가 호출이 되면, 하나의 컨테이너를 띄우고 작업을 처리한다. (vmware나 virtual box 처럼 일종의 가상머신으로 프로그램을 돌리는 것이라고 이해해도 된다)<br>
만약 요청을 처리하는 와중에 다시 람다함수가 호출이 되면 또다른 컨테이너를 띄우기 때문에 동시성이 증가한다. 


[동시성을 해결하는 방법]

1. 예약된 동시성을 통해 동시성 개수 늘리기<br>
함수에 대한 최대 동시 인스턴스를 보장하는 옵션이다.<br>
예약된 동시성을 통해 한 함수가 동시성을 예약하면 다른 함수가 해당 동시성을 사용할 수 없게 된다.<br>
예를들어 쇼핑몰에서 900명의 이용자가 상품을 구매한다고 했을때, 이 예약 처리를 람다로 하는데, 만일 다른 200명의 사용자가 게시글을 올리는 행위(람다로 처리한가고 가정)를 했을때 1000개 동시성 제약때문에 100명의 이용자의 구매 작업이 지연되어 서비스 이용에 치명적이게 될수 있다.<br>
따라서 특정 람다함수에 대한 최대 동시 인스턴스 수를 보장해준다는 의미이다. (프로비저닝과는 다르게 예약된 동시성을 구성하는 데는 요금이 부과되지 않음)

2. Limit Increase 요청<br>
하지만 서비스 이용객 특성상 아무리 최적화를 해도 어쩔 수 없이 최대동시성 수를 넘어갈 경우, AWS에 동시실행 수 늘려달라고 서비스 할당량 증가 요청을 할 수 있다.

[reference](https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-%EB%9E%8C%EB%8B%A4Lambda-%EA%B0%9C%EB%85%90-%EC%9B%90%EB%A6%AC) : https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-%EB%9E%8C%EB%8B%A4Lambda-%EA%B0%9C%EB%85%90-%EC%9B%90%EB%A6%AC


## Lambda 함수
Lambda 함수는 AWS Lambda에서 실행되는 함수를 말한다.

Lambda 함수는 다양한 프로그래밍 언어로 작성될 수 있다. <br>
AWS에서는 Node.js, Python, Java, Go, Ruby, C# 등을 지원한다. <br>
이 함수는 일반적으로 이벤트 드리븐(event-driven) 방식으로 동작하며, 특정 이벤트가 발생하면 해당 함수가 호출되어 코드를 실행한다.

Lambda 함수는 실행 시간에만 과금되며, 일반적으로 빠른 속도로 작동한다. <br>
함수의 실행 환경은 개발자가 선택한 프로그래밍 언어에 따라 달라진다. <br>
예를 들어, Node.js를 사용하는 경우 AWS에서는 함수 실행을 위해 Node.js 실행 환경을 준비한다.

Lambda 함수는 여러 가지 용도로 사용될 수 있다.<br> 
예를 들어, HTTP 요청을 처리하고 응답하는 RESTful API 서버, 데이터베이스에 접근하여 데이터를 가져오는 백엔드 서버 등을 만들 수 있다. <br>
또한, AWS에서 제공하는 다른 서비스와 연동하여 서버리스 아키텍처를 구축할 수 있다.


### Lambda 함수가 Stateless여야 하는 이유
1. 서버리스 아키텍처에서는 함수 실행 환경이 매번 생성되며 실행이 완료되면 제거된다. <br>
이는 함수 실행 간의 Stateful 상태를 유지할 수 없음을 의미한다.

2. Stateful 함수를 사용하면 함수의 처리를 수행하는 인스턴스 간에 데이터를 공유해야한다. <br>
이는 함수 실행을 복잡하게 만들고, 동기화 문제와 데이터 일관성 문제를 발생시킬 수 있다.

3. Stateful 함수는 확장성이 제한된다. <br>
여러 인스턴스에서 데이터를 공유하면 데이터 일관성 문제가 발생할 수 있기 때문이다. <br>
따라서 서버리스 아키텍처에서는 Stateful 함수 대신 Stateless 함수를 사용해야한다.

따라서 AWS Lambda 함수에서는 상태(State)를 저장하는 것이 아니라, 입력(Input)을 처리하여 출력(Output)을 반환하는 Stateless 함수를 구현해야 한다. <br>
이를 통해 함수의 독립성, 확장성, 유연성을 보장할 수 있다.


## Lambda 트리거
AWS Lambda 함수는 이벤트에 의해 트리거되어 실행된다. <br>
이벤트는 트리거를 발생시키는 원인이 되는 일종의 신호이다. <br>
AWS Lambda에서는 다양한 트리거를 제공한다.

- API Gateway: RESTful API 또는 WebSocket API를 생성하여 AWS Lambda 함수를 트리거한다.
- AWS CloudFormation: AWS CloudFormation 스택의 생성, 업데이트 또는 삭제를 감지하여 AWS Lambda 함수를 트리거한다.
- CloudFront: Amazon CloudFront에 대한 이벤트, 예를 들어 캐시된 컨텐츠를 가져오기 전에 Lambda 함수를 사용하여 사용자 지정 로직을 실행할 수 있다.
- CloudWatch Events: 예약된 이벤트 또는 대상 애플리케이션에서 발생한 이벤트를 트리거한다.
- Kinesis: AWS Kinesis 스트림으로부터 데이터를 읽어와 Lambda 함수를 트리거한다.
- S3: Amazon S3 버킷에서 객체가 생성, 업데이트 또는 삭제될 때 Lambda 함수를 트리거한다.
- SNS: Amazon SNS 주제에서 새로운 메시지가 게시될 때 Lambda 함수를 트리거한다.
- SQS: Amazon SQS 대기열에 새로운 메시지가 생성될 때 Lambda 함수를 트리거한다.

<br><br><br>

# API Gateway
API Gateway란 규모에 상관없이 API 생성, 유지 관리, 모니터링과 보호를 할 수 있게 해주는 서비스이다.

말 그대로 Client에서 server로 통신할 때 사용하는 많은 api들의 대문(게이트웨이)과 같은 역할을 한다고 보면 된다.

즉, API가 지나가는 통로인 셈이다.

API Gateway를 이용하면 통합적으로 엔드포인트와 REST API를 관리할 수 있다.

API 게이트웨이를 등록해주면, 모든 클라이언트는 각 서비스의 엔드포인트 대신 API Gateway로 요청을 전달하여 관리가 용이해 진다. <br>
사용자가 설정한 라우팅 설정에 따라 각 엔드포인트로 클라이언트를 대리하여 요청하고 응답을 받으면 다시 클라이언트에게 전달하는 프록시(proxy) 역할을 하기 때문이다.

API Gateway 서비스는 단순히 api 경유지 역할 뿐만 아니라, 엔드포인트 서버에서 공통으로 필요한 인증/인가, 사용량 제어, 요청/응답 변조 등의 다양한 기능을 플러그인 형태로 제공하고 있다.

이러한 플러그인을 API 게이트웨이에서 사용하면, 각 엔드포인트의 서버마다 위의 기능들을 구현하지 않아도 되기 때문에 개발자 입장에서는 개발 비용을 줄일 수 있다는 효과도 있다.

특히 API Gateway를 통해 Lambda와 연동하여 Serverless 서비스를 구축하는데 많이 사용된다.

## 사용하는 이유?
클라이언트와 서버 간의 분리: API Gateway는 클라이언트와 백엔드 서버 사이에 위치하므로 클라이언트와 서버 간의 분리를 가능하게한다. <br>
이를 통해 마이크로서비스 아키텍처와 같은 모던한 아키텍처를 적용할 수 있으며, 백엔드 서버가 API Gateway를 통해 외부로 노출되지 않도록 보안을 강화할 수 있다.

로드 밸런싱 및 스케일링: API Gateway는 로드 밸런싱 기능을 제공하므로 트래픽이 많은 API 엔드포인트의 경우 여러 개의 백엔드 서버로 분산시킬 수 있다. <br>
또한, API Gateway는 자동 스케일링 기능을 제공하므로 트래픽이 증가할 경우 서버를 자동으로 추가하여 대응할 수 있다.

인증 및 권한 부여: API Gateway는 클라이언트 인증과 API 엔드포인트별 권한 부여를 지원한다. <br>
이를 통해 API 엔드포인트의 보안을 강화할 수 있다.

API 버전 관리: API Gateway는 API 엔드포인트의 버전 관리를 지원한다. <br>
이를 통해 API 엔드포인트의 변경이 있을 경우 기존 클라이언트와의 호환성을 유지할 수 있다.

모니터링 및 로깅: API Gateway는 API 엔드포인트의 트래픽을 모니터링하고 로깅할 수 있다. <br>
이를 통해 API 엔드포인트의 사용량을 파악하고, 문제가 발생했을 경우 로그를 통해 원인을 분석할 수 있다.


## 제공 API 유형
API Gateway에서 제공하는 API는 대표적으로 3종류가 있다.

- HTTP API : API 프록시 기능정도만 필요할 때 적합. 단순 / 저렴하고 빠르다.
- REST API : API 관리 기능, 요청/응답에 대한 제어가 필요할 경우 적합, 복잡 / 비싸고 느리다.
- WebSocket API : 웹소켓 용도. 실시간 애플리케이션에서 주로 사용한다.


### HTTP API
- HTTP를 통신 방식으로 사용하는 API를 HTTP API라고 한다.
- HTTP API는 Endpoint를 API gateway로 활용하여 HTTP 요청을 통해서 서버에 접근할 수 있도록 만들어준다.
- HTTP API는 데이터만 주고 받고 UI 화면이 필요하면 클라이언트가 별도로 처리한다. 대게 앱/웹/서버 to 서버에서 사용된다.
- 대부분의 Web API가 HTTP API로 이루어지고 있다.


### REST API
- REST API는 HTTP API에 여러가지 제약 조건이 추가된 형태이다.
  - 자원의 식별
  - 메시지를 통한 리소스 조작
  - 자기서술적 메세지
  - 애플리케이션의 상태에 대한 엔진으로서 하이퍼미디어
- REST는 웹 서비스의 구조를 만드는데 활용되는 패턴이며 위의 4가지 제약조건을 만족해야 RESTFUL 하다라고 말할 수 있다.
- 대표적으로 CRUD 메서드 동작을 일컫는다. CREATE(post), READ(get), UPDATE(put), DELETE(delete)
- 그런데 이런 부분을 완벽하게 지키면서 개발하는 것은 현실적으로 어렵고, 또 추가 개발 비용대비 효과가 있는 것도 아니어서, 이미 많은 사람들이 해당 조건을 지키지 않아도 REST API라고 하기 때문에, HTTP API나 REST API를 거의 같은 의미로 사용하고 있는 현실이다. (물론 엄격하게는 다르다)


### WEBSOCKET API
- 요청을 받고 응답하는 REST API와 달리 WebSocket API는 클라이언트 앱과 백엔드 간의 양방향 통신을 지원한다.
- 웹 소켓은 사용자의 브라우저와 서버 사이의 인터액티브 통신 세션을 설정할 수 있게 하는 고급 기술 이다.
- 채팅 앱 및 스트리밍 대시보드와 같은 실시간 양방향 통신 애플리케이션을 구축하여 백엔드 서비스와 클라이언트 간의 메시지 전송을 처리하기위해 지속적인 연결을 유지한다.


## 요금 정책
API Gateway는 람다와 같이 서버리스 서비스이며, 수신한 API 호출에 대해서만 지불한다.

다만 HTTP API / REST API / WEBSOCKET API 각각 모두 요금대가 다르다.
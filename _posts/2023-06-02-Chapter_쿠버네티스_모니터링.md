---
title:  "쿠버네티스 모니터링"
excerpt: "DevOps 부트캠프 Section 4"

categories:
  - Blog
tags:
  - [Blog, DevOps]

toc: true
toc_sticky: true
 
date: 2023-06-02
last_modified_at: 2023-06-02
---
# 쿠버네티스 모니터링
쿠버네티스에 모니터링을 보면 많은 툴과 지표들이 있어서 혼돈하기 쉬운데 , 먼저 모니터링 컨셉에 대한 이해를 할 필요가 있다.

쿠버네티스 기반의 시스템을 모니터링하기 위해서는 크게  
1.   host
2.   container
3.   app  
4.  kubernetes 4가지를 모니터링 해야 한다.

1. host :  쿠버네티스 컨데이너를 실행하는 하드웨어 호스트 ,  노드에 대한 지표 모니터링이 필요하다.  노드의 cpu , 메모리, 디스크, 네트워크, 사용량과 노드 os와 커널에 대한 모니터링

2. container :  노드에 기동되는  각각의 컨테이너에 대한 정보이다. 컨테이너의 CPU,메모리, 디스크, 네트워크 사용량을 모두 모니터링한다.

 
3.  application :  컨테이너에서 구동되는 개별 어플리케이션에 대한 컨테이너이다. <br> 
ex)  컨테이너에서 기동되는 node.js기반의 애플리케이션의 http 에러 빈도등

4.  kubernetes :  컨테이너를 컨트롤하는 쿠버네티스 자체에 대한 모니터링한다. 쿠버네티스의 자원인 서비스나 pod  계정 정보등이 해당된다.

쿠버네티스 기반의 시스템 모니터링에 대해서 혼동이 오는 부분중 하나가 모니터링이라는 개념이 포괄적이 때문이다.  <br> 
여기서 다루는 모니터링은 자원에 대한 지표 대한 모니터링이다. <br>  포괄적인 의미 모니터링은 로그와 에러 모니터링등 다양한  내용을 포괄한다.


## 쿠버네티스 로링
지표 모니터링과 함께 중요한 모니터링 기능  중 하나는 로그 수집 및 로그 모니터링이다.

로그 수집 및 로그 모니터링 방법은 여러가지 방법이 있지만  오픈소스 로그 수집 모니터링 조합인 (Elastic search + FluentD + kibina) 스택을 사용하는 경우가 대표적이다. <br> 
EFK방식은 보다 최근엔 prometheus등 다양한 모니터링 아키텍처가 후보로 고려되어진다.

개인적인 의견으로는 직접 모니터링 솔루션을 구축해서 사용하는 것보다 비용은 약간 들지만 클라우드 밴더에서 제공하는  모니터링도구나  데이타톡스와 같은 전문 모니터링 솔루션을 사용하는 것을 추천한다.

직접 모니터링 솔류션을 구축할 경우  구축과 운영에 드는 노력도 크고  또한 어떠한 지표를 모니터링에 넣어야할지 등에 대한 추가적인 노하우가 요한다 . <br> 
또한 cAdvisor, heapster, protheus조합은  호스트 , 컨테이너 그리고 쿠버네팃에 대한 모니터링은 제공하지 않지만 애플리케이션 지표에 대한 모니터링과 로깅 기능은 제공하지 않기 때문에 별도의 구축이 필요하다. <br> 
이런 노력을 들이는 것 보다는 모든 기능이 한번에 제공되는 운영을 대해해주는 데이타톡스나  클라우드에서 제공해주는 모니터링 솔루션을 사용하는게 편하다라는 말이다.


## cAdvisor
에이전트로 각노드마다 설치되어  노드에 대한 정보와 컨테이너에 대한 정보를 수집하여 k8s에 전달한다.

### Heapster
cAdvisor에 의해 수집되는 heapster라는  중앙집중화된 지표 수집 시스템에 모이게되고 , heapster는 수집된 지표를 스토리지 백엔드에 저장한다.

### Storage backend
heapster가 지표에 저장하는  베이터베이스를 스토리지 백엔드라 하는데  heapster는  확장성을 위해서 다양한 스토리지 백엔드를  플러그인 구조를 선택하여 연결할수잇다.

현재 제공되는  대표적인 스토리지 백엔드는 구글클라우드의 모니터링 시스템인 스택드라이버, 오픈소스 시계열 데이타베이스인 인플럭스 디비를 지원한다.

### 그래프 대쉬보드

이렇게 저장된 모니터링 지표는 그래프와 같은 형태로 시각화 될 필요가 잇는데, 스토리지 백엔드를 지원하는 다양한 시각화 도구를 사용할 수 있다. <br> 
구글의 모니터링 시스템인 스택드라이버의 경우에는  자체적인 대쉬보드 및  그래프 인터페이스가 있고, 인플럭스 디비나 프로메테우스의 경우에는 오픈소스  시각화 도구인 그라파나를 사용할 수있다.


## 프로메테우스(prometheus)
프로메테우스는  sound Could에서 개발된 모니터링 툴로 CNCF에 오픈소스로 기부되었다.  <br> 
지표 수집을 통한 모니터링을 주요 기능으로 하고있다.

쿠버네티스  모니터링뿐만아니라 애플리케이션이나 서버 os등 다양한 대상으로부터 지표를 수집하며 모니터링할 수 있는 범용 솔루션으로 아래와 같은 구조를 가집니다.

 
### 데이터 수집
프로메테우스는 수집을 pulling 모델을 사용한다. 모니터링 대상이되는 자원이 지표 정보를 프로메테우스로 보내는 것이 아니라, 프로메테우스가 주기적으로 모니터링 대상에서 지표를 읽어 오는 모델을 사용한다.

모니터링 대상이 프로메테우스 데이타 포멧을 지원할 경우 바로 읽어 올 수 있고, 만약에 지원하지 않는다면  별도의 에이전트를 설치해서 지표를 읽어올 수 있는데, 이를 exporter라고한다.  <br> 
exporter는 mysql,nginx, redis와 같은 패키지는 미리 개발된 export가 있어서 다양한 서비스의 지표까지 쉽게 읽어올 수 있다. <br> 
이런 패키지 어플리케이션이 아니라 java나 node.js와 같은 사용자 애플리케이션의 경우에는 exporter를 사용하는 방법 말고도  프로메테우스 클라이언트 라이브러리를 사용하게 되면 바로 지표를 프로메테우스 서버로 보낼수 있다. 

마지막으로  push gateway를 사용하는 방법이 있는데 배치나 스케쥴 작업 같은 경우에는 항상 서비스가 떠있는 것이 아니라 필요한 경우에만 떠 있다가 작업이 끝나면 사자리는 경우이다.  <br> 
그래서 이런서비스를 pulling으로 지표를 얻어오기가 어려울 수 있는데, 이를 보완하기 위해서, 이런 서비스들이 push->push gateway에 지표를 쏴주면 push gateway가 지표를 보관했다고 있다가 프로메테우스 서버가 pulling을 하면 저장된 지표 정보를 리턴하도록 한다.


### 서비스 디스커버리
그러면 프로메테우스는 모니터링 대상을 어떻게 알 수 있을까 ? 당연히 모니터링 대상목록을 유지하고, 대상에 대한 ip나 기타 정보를 설정 파일에 주면 , 그정보를 기반으로 프로메테우스 서버가 모니터링 정보를 읽어온다.

그러나 오토스케일을 많이 사용하는 클라우드 환경이나 쿠버네티스와 같은 컨테이너환경에서는 모니터링 대상의 ip가 동적으로 변경되는 경우가 많기 때문에 이를 일일이 설정 파일에 넣는데 한계가 있다. <br> 
이런한 문제를 해결하기 위해서 프로메네테우스는 디스커버리를 사용하는데 모니터링 대상이 등록되어 있는 장소에서 목록을 받아서 그 대상을 모니터링하는 형태이다.

프로메테우스는 DNS나 consul, etcd와 같은  다양한 서비스 디스커버리 서비스와 연동을 통해서 자동으로 모니터링 대상의 목록을 가지고 올 수 있다.


### 저장 및 시각화
수집된 지표 정보들은 프로메테우스 내부의 시계열 데이터베이스에 저장되고, 프로메네우스 웹콘솔을 이용하여 시각화되거나 또는 api를 외부에 제공해서 grafana와 같은 시각화 툴을 통해서 지표를 시각화 해서 볼 수 있다.

 
### 알림서비스
부가지능중 하나로 alerting 컴포넌트는 지표에 대한 규칙을 걸어놓고 그 규칙을 위반할 경우에는 알림을 보낼 수 있는 기능을 가지고 있다. 알림을 보내는 대상은 이메일이나 gagerduty와 같은 notification서비스 등과  연동이 가능하다.


### 쿠버네티스 연동 아키텍처
쿠버네티스와 프로메테우스는 어떻게 연동이 되는지 알아보자.  프로메테우스는  범용 모니터링 솔루션으로 프로메테우스가 지표정보를 읽어올 수 만 있다면 거의 모든 정보를 읽어올 수 있는 구조이기 때문에, 쿠버네티스 연동에 있어도 자유도가 매우 높다.

단 레퍼런스 할 수 있는 구성은 있는데  아래와 같다.
![alt text](/images/kubepro.png)

프로메테우스 서버가 모니터링할 리소스를 찾기 위해서 서비스 디스커버리 메카니즘이 필요한데, 이를 위해서 쿠버네티스 api를 호출해서 자원들의 목록(pod,node,ingress,endpoint등)의 목록을 라벨 셀렉터를 이용하여 수집한다.

다음 수집된 모니터링대상에 대해서모니터링을 수행하는데 , 쿠버네티스는 apiserver에서 /metric이라는 url을 통해서  기본적인 지표 정보를 리턴하기 때문에 쿠버네티스 자원들에 대한 모니터링은 이 api를 통해서 수집하게된다.

아랫단에  아드웨어 즉 node에 대한 정보는 api를 통해서 수집하기가 어렵기 때문에 node에 node exporter를 설치해서 하드웨어와 os에 대한 정보를 수집한다.  컨테이너에 대한 정보는 node 별ㅗ 배포되어 있는 cAdvisor가 이를 수집하여 프로메테우스에 제공한다

컨테이너 내에서 기동되는 애플리케이션에 대한정보는 필요한 경우  클라이언트 sdk나 솔루션에 맞는 exporter를 이용해서 수집한다.



[reference](https://base-on.tistory.com/353) : https://base-on.tistory.com/353